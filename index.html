<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- NUEVA LÍNEA: Conecta con el archivo de manifiesto -->
    <link rel="manifest" href="manifest.json">
    
    <title>Sistema Agrícola de Evaluación</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>

    <!-- Todo el contenido de tus vistas (login, bienvenida, etc.) va aquí sin cambios -->
    <!-- VISTA DE INICIO DE SESIÓN / REGISTRO -->
    <div id="vista-login" class="view">
        <div class="card">
            <h1>Bienvenido al Sistema</h1>
            <div id="login-form">
                <h2>Iniciar Sesión</h2>
                <input type="text" id="login-usuario" placeholder="Nombre de usuario" autocomplete="username">
                <input type="password" id="login-password" placeholder="Contraseña" autocomplete="current-password">
                <button id="btn-login" class="btn btn-primary">Entrar</button>
                <p>¿No tienes cuenta? <a href="#" id="link-a-registro">Regístrate aquí</a></p>
            </div>
            <div id="registro-form" class="hidden">
                <h2>Registrar Nuevo Usuario</h2>
                <input type="text" id="registro-usuario" placeholder="Elige un nombre de usuario" autocomplete="username">
                <input type="password" id="registro-password" placeholder="Elige una contraseña" autocomplete="new-password">
                <button id="btn-registro" class="btn btn-primary">Registrar</button>
                <p>¿Ya tienes cuenta? <a href="#" id="link-a-login">Inicia sesión</a></p>
            </div>
        </div>
    </div>

    <!-- VISTA DE BIENVENIDA Y SELECCIÓN DE LOTE -->
    <div id="vista-bienvenida" class="view hidden">
        <div class="card">
            <div class="header-bienvenida">
                <h1 id="titulo-bienvenida">Sistema de Evaluación Agrícola</h1>
                <button id="btn-logout" class="btn">Cerrar Sesión</button>
            </div>
            <p>¿Qué lote se evaluará hoy?</p>
            <div id="lista-seleccion-lotes"></div>
            <button id="btn-crear-nuevo-lote" class="btn btn-primary">Crear Nuevo Lote</button>
            <hr>
            <button id="btn-ver-resultados" class="btn">Ver Promedios de Hoy</button>
            <button id="btn-ir-a-gestion-plagas" class="btn">Gestionar Plagas</button>
            <button id="btn-ir-a-config-calculo" class="btn">Editar Fórmulas de Cálculo</button>
        </div>
    </div>

    <!-- VISTA PRINCIPAL DE EVALUACIÓN -->
    <div id="vista-evaluacion" class="view hidden">
        <header>
            <h1 id="evaluacion-titulo-lote"></h1>
            <button id="btn-volver-inicio" class="btn">Volver al Inicio</button>
        </header>
        <nav id="nav-valvulas" class="tabs-nav"></nav>
        <button id="btn-agregar-valvula" class="btn btn-secondary">+ Agregar Válvula</button>
        <main id="contenido-valvula">
            <div class="card">
                <label for="puntos-evaluados">Puntos evaluados en esta válvula:</label>
                <input type="number" id="puntos-evaluados" min="1">
            </div>
            <div class="card" id="card-racimos">
                <h3>Número de Racimos</h3>
                <div id="contenedor-racimos"></div>
            </div>
            <div class="card">
                <h3>Conteo de Plagas</h3>
                <div id="contenedor-conteos"></div>
            </div>
        </main>
    </div>

    <!-- VISTA DE GESTIÓN DE PLAGAS -->
    <div id="vista-gestion-plagas" class="view hidden">
        <div class="card">
            <h2>Gestión de Plagas</h2>
            <p>Añade, edita o elimina las plagas que se usarán en las evaluaciones.</p>
            <input type="text" id="input-nueva-plaga-gestion" placeholder="Nombre de la nueva plaga">
            <button id="btn-agregar-plaga-gestion" class="btn btn-primary">Agregar Plaga</button>
            <ul id="lista-plagas-gestion"></ul>
            <button id="btn-volver-inicio-desde-plagas" class="btn">Guardar y Volver</button>
        </div>
    </div>

    <!-- VISTA DE RESULTADOS -->
    <div id="vista-resultados" class="view hidden">
        <div class="card">
            <h2>Resultados del Día</h2>
            <p>Selecciona un lote para ver sus promedios.</p>
            <div id="lista-seleccion-lotes-resultados"></div>
            <div id="contenido-resultados" class="hidden">
                <h3 id="titulo-resultados-lote"></h3>
                <div class="export-buttons-container">
                    <button id="btn-exportar-pc" class="btn btn-primary">Exportar para PC (Excel)</button>
                    <button id="btn-exportar-movil" class="btn btn-secondary">Exportar para Móvil</button>
                </div>
                <h4>Promedio General del Lote</h4>
                <table id="tabla-promedio-general"></table>
                <h4>Promedio por Válvula</h4>
                <div id="tablas-por-valvula"></div>
            </div>
            <button id="btn-volver-inicio-desde-resultados" class="btn">Volver al Inicio</button>
        </div>
    </div>
    
    <!-- VISTA DE CONFIGURACIÓN DE CÁLCULOS -->
    <div id="vista-config-calculo" class="view hidden">
         <div class="card">
            <h2>Configuración de Fórmulas</h2>
            <p>Define la fórmula para el promedio de cada plaga.</p>
            <div id="contenedor-formulas"></div>
            <button id="btn-guardar-formulas" class="btn btn-primary">Guardar Fórmulas</button>
            <button id="btn-volver-inicio-desde-config" class="btn">Volver al Inicio</button>
         </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script src="app.js"></script>
    
    <!-- NUEVO SCRIPT: Registra el Service Worker -->
    <script>
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('/sw.js').then(registration => {
            console.log('ServiceWorker registrado con éxito:', registration.scope);
          }, err => {
            console.log('Fallo en el registro del ServiceWorker:', err);
          });
        });
      }
    </script>
</body>
</html>